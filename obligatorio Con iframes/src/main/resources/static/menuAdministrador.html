<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menú Administrador</title>
    <link rel="stylesheet" href="Peaje.css">
    <script src="vistaWeb.js"></script>
</head>
<body>
    <script src="utilesVista.js"></script>
    
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-title">Sistema de Peajes - Panel Administrador</div>
            <div class="navbar-buttons">
                <button class="nav-btn active" data-vista="emular">Emular Tránsito</button>
                <button class="nav-btn" data-vista="bonificaciones">Bonificaciones</button>
                <button class="nav-btn" data-vista="estado">Estado</button>
                <button class="nav-btn" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div id="vistaEmular" class="vista active">
            <div class="container">
                <h2>Emular Tránsito de Vehículo</h2>
                
                <div class="form-group">
                    <label for="selectPuesto">Seleccionar Puesto:</label>
                    <select id="selectPuesto">
                        <option value="">Cargando puestos...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="inputMatricula">Matrícula del Vehículo:</label>
                    <input type="text" id="inputMatricula" placeholder="Ej: ABC1234">
                </div>

                <div class="form-group">
                    <label for="inputFecha">Fecha y Hora:</label>
                    <input type="datetime-local" id="inputFecha">
                </div>

                <div class="form-group" style="align-items: center;">
                    <button type="button" class="btn-primary" onclick="emularTransito()">Emular Tránsito</button>
                </div>

                <div id="listaTarifas" class="tarifas-container"></div>

                <div id="resultadoEmulacion" class="resultado-container"></div>
            </div>
        </div>

        <div id="vistaBonificaciones" class="vista">
            <div class="container">
                <h2>Gestión de Bonificaciones</h2>
                <p>Aquí se gestionarán las bonificaciones del sistema.</p>
            </div>
        </div>

        <div id="vistaEstado" class="vista">
            <div class="container">
                <h2>Estado del Sistema</h2>
                <p>Aquí se mostrará el estado general del sistema de peajes.</p>
            </div>
        </div>
    </div>

    <script>
        urlIniciarVista="/menuAdministrador/vistaConectadaAdministrador";

        function cambiarVista(vista) {
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            const vistas = {
                'emular': 'vistaEmular',
                'bonificaciones': 'vistaBonificaciones',
                'estado': 'vistaEstado'
            };
            
            document.getElementById(vistas[vista]).classList.add('active');
        }

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if(this.getAttribute('onclick')) return;
                const vista = this.getAttribute('data-vista');
                if(vista) {
                    this.classList.add('active');
                    cambiarVista(vista);
                }
            });
        });

        function logout() {
            submit("acceso/logoutAdministrador", null)  
        }

        function mostrar_usuarioNoAutenticado(urlDestino){
            window.location.href = urlDestino;
        }

        function procesarRespuesta(respuesta) {
            console.log("Respuesta recibida:", respuesta);
            
            if (respuesta.tipo === "usuarioNoAutenticado") {
                window.location.href = respuesta.valor;
                return;
            }
            
            if (respuesta.tipo === "puestos") {
                console.log("Puestos recibidos:", respuesta.valor);
                mostrar_puestos(respuesta.valor);
            }

            // Procesar respuesta de emular tránsito
            if (respuesta.tipo === "resultadoEmulacion") {
                console.log("Resultado emulación:", respuesta.valor);
                mostrar_resultadoEmulacion(respuesta.valor);
            }
            
        }

        function mostrar_puestos(puestos) {
            console.log("Mostrando puestos:", puestos);
            const select = document.getElementById('selectPuesto');
            
            if (!select) {
                console.error("No se encontró el select");
                return;
            }
            
            select.innerHTML = '<option value="">Seleccione un puesto</option>';
            
            if (!puestos || puestos.length === 0) {
                console.log("No hay puestos");
                select.innerHTML = '<option value="">No hay puestos disponibles</option>';
                return;
            }
            
            puestos.forEach((puesto, index) => {
                console.log("Agregando puesto:", puesto);
                const option = document.createElement('option');
                option.value = puesto.nombre;
                option.textContent = puesto.nombre;
                option.dataset.puesto = JSON.stringify(puesto);
                select.appendChild(option);
            });
        }

        function obtenerPuestoSeleccionado() {
            const select = document.getElementById('selectPuesto');
            if (!select || select.selectedIndex <= 0) return null;
            
            const option = select.options[select.selectedIndex];
            if (option && option.dataset.puesto) {
                return JSON.parse(option.dataset.puesto);
            }
            return null;
        }

        function cargarTarifasPuesto(puesto) {
            const listaTarifas = document.getElementById('listaTarifas');
            listaTarifas.innerHTML = '';
            
            if (!puesto.tarifas || puesto.tarifas.length === 0) {
                listaTarifas.innerHTML = '<p style="text-align: center; color: #666;">No hay tarifas definidas</p>';
                return;
            }
            
            const titulo = document.createElement('h3');
            titulo.textContent = 'Tarifas - ' + puesto.nombre;
            listaTarifas.appendChild(titulo);
            
            puesto.tarifas.forEach(tarifa => {
                const div = document.createElement('div');
                div.className = 'tarifa-item';
                div.innerHTML = `
                    <span><strong>${tarifa.categoriaDeVehiculo.nombre}</strong></span>
                    <span class="tarifa-monto">$ ${tarifa.monto.toFixed(2)}</span>
                `;
                listaTarifas.appendChild(div);
            });
        }

        function emularTransito() {
            console.log('=== INICIO emularTransito ===');
            
            try {
                const puesto = obtenerPuestoSeleccionado();
                console.log('Puesto obtenido:', puesto);
                
                const matricula = document.getElementById('inputMatricula').value.trim();
                console.log('Matrícula:', matricula);
                
                const fecha = document.getElementById('inputFecha').value;
                console.log('Fecha:', fecha);
                
                if (!puesto) {
                    alert('Por favor seleccione un puesto');
                    console.log('ERROR: No hay puesto seleccionado');
                    return;
                }
                
                if (!matricula) {
                    alert('Por favor ingrese una matrícula');
                    console.log('ERROR: No hay matrícula');
                    return;
                }

                if (!fecha) {
                    alert('Por favor seleccione una fecha y hora');
                    console.log('ERROR: No hay fecha');
                    return;
                }
                
                console.log('Emulando tránsito:', {
                    puesto: puesto.nombre,
                    matricula: matricula,
                    fecha: fecha
                });
                
                // Convertir a URL-encoded
                const params = new URLSearchParams();
                params.append('puesto', puesto.nombre);
                params.append('matricula', matricula);
                params.append('fecha', fecha);
                
                console.log('Llamando a submit...');
                submit("menuAdministrador/emularTransito", params.toString());
                
            } catch (error) {
                console.error('ERROR en emularTransito:', error);
                alert('Error: ' + error.message);
            }
            
            console.log('=== FIN emularTransito ===');
        }

        function mostrar_resultadoEmulacion(datos) {
            console.log("Mostrando resultado:", datos);
            const contenedor = document.getElementById('resultadoEmulacion');
            
            if (!datos) {
                contenedor.innerHTML = '<p class="error">No se recibieron datos del tránsito</p>';
                return;
            }
            
            contenedor.innerHTML = `
                <div class="resultado-exito">
                    <h3>✓ Tránsito Registrado Exitosamente</h3>
                    <div class="resultado-detalles">
                        <div class="resultado-item">
                            <strong>Propietario:</strong> ${datos.nombrePropietario}
                        </div>
                        <div class="resultado-item">
                            <strong>Categoría:</strong> ${datos.categoria}
                        </div>
                        <div class="resultado-item">
                            <strong>Bonificación:</strong> ${datos.bonificacion}
                        </div>
                        <div class="resultado-item">
                            <strong>Costo del Tránsito:</strong> $${datos.costoTransito.toFixed(2)}
                        </div>
                        <div class="resultado-item">
                            <strong>Saldo Después:</strong> $${datos.saldoDespues.toFixed(2)}
                        </div>
                    </div>
                </div>
            `;
            
            // Limpiar formulario
            document.getElementById('inputMatricula').value = '';
            document.getElementById('inputFecha').value = '';
            
            // Scroll suave al resultado
            contenedor.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        document.addEventListener('DOMContentLoaded', function() {
            cambiarVista('emular');
            
            const selectPuesto = document.getElementById('selectPuesto');
            if (selectPuesto) {
                selectPuesto.addEventListener('change', function() {
                    const puestoSeleccionado = obtenerPuestoSeleccionado();
                    console.log("Puesto seleccionado:", puestoSeleccionado);
                    if (puestoSeleccionado) {
                        cargarTarifasPuesto(puestoSeleccionado);
                    } else {
                        document.getElementById('listaTarifas').innerHTML = '';
                    }
                });
            }
        });
        
    </script>
</body>
</html>